---
title: "GSE74548: Gene Methylation Enrichment Analysis"
author: "hcy_meth meta-analysis group"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: true
    code_folding: hide
    fig_width: 7
    fig_height: 7
theme: cosmo
---

##  Introduction

Previously, Mandhri and I analysed the B-PROOF 450K data, trying to understand
whether vitamin supplementation caused changes in gene methylation.
We used Limma and some basic analyses, which showed no specific probes with FDR<0.05,
nor any DMRs.

In this analysis we will use the principle of Gene Set Enrichment Analysis, applying it
to many probes belonging to genes.
If the probes are trending in concert, then we can make some judgement about the
enrichment of those probes.
The statistical test used is the Wilcox test, which can be applied to competitive 
or self contained test types.

```{r,libs}

library("parallel")
library("dplyr")
library("kableExtra")
library("eulerr")
library("mitch")

```

# DM1 - post trial supplement versus placebo

## Whole gene analysis

```{r,dma1a}

dm <- read.table("dma1a.tsv")
head(dm,50) %>%
  kbl(caption = "Top significant genes with limma") %>%
  kable_paper("hover", full_width = F)

# histogram of t values
hist(dm$t,breaks=seq(from=-6,to=6,by=1))

# set cores to used for parallel execution
CORES= detectCores()

# make a vector of unique gene names
gn <- unique(unlist(strsplit( dm$UCSC_RefGene_Name ,";")))
gnl <- strsplit( dm$UCSC_RefGene_Name ,";")

# run the test (self contained)
gme_res <- mclapply( 1:length(gn), function(i) {
  g <- gn[i]
  myrows <- which(lapply(gnl,function(x) {
    length(which(x==g))
  } ) > 0 )
  tstats <- dm[myrows,"t"]
  tstats <- tstats[order(tstats)]
  myn <- length(tstats)
  mymean <- mean(tstats)
  mymedian <- median(tstats)
  wtselfcont <- wilcox.test(tstats)

  res <- c("gene"=g,"nprobes"=myn,"mean"=mymean,"median"=mymedian,
           "p-value(selfcontained)"=wtselfcont$p.value)
} , mc.cores=CORES)

# format the results
gme_res_df <- do.call(rbind, gme_res)
rownames(gme_res_df) <- gme_res_df[,1]
gme_res_df <- gme_res_df[,-1]
tmp <- apply(gme_res_df,2,as.numeric)
rownames(tmp) <- rownames(gme_res_df)
gme_res_df <- as.data.frame(tmp)

# results are sorted by the sum of -log10 of the p-values
gme_res_df$sig <- -log10(gme_res_df[,4])

gme_res_df <- gme_res_df[order(-gme_res_df$sig),]

gme_res_df$`fdr(selfcontained)` <- p.adjust(gme_res_df$`p-value(selfcontained)`)

gme_res_df_wholegene <- gme_res_df

write.table(gme_res_df_wholegene,file="gmea_wholegene.tsv")

```

## Table of top results.

```{r, toptable}

head(gme_res_df,50) %>%
  kbl(caption = "Top significant genes with GMEA") %>%
  kable_paper("hover", full_width = F)

```

## Volcano plots

```{r,volcano1}

# volcano selfcont
sig <- subset(gme_res_df,`fdr(selfcontained)` < 0.05)
plot(gme_res_df$median , -log10(gme_res_df$`p-value(selfcontained)`) ,
  xlab="effect size (mean t-stat)", ylab="-log10(p-value)",
  pch=19, cex=0.5, col="gray",main="self contained test")
grid()
points(sig$median , -log10(sig$`p-value(selfcontained)`) ,
  pch=19, cex=0.5, col="red")

```

## Boxplots

Boxplots smallest pvalue.

```{r,box1}

par(mfrow=c(1,2))
n=50
# self contained
gs <- head(rownames(gme_res_df[order(gme_res_df$`p-value(selfcontained)`),]),n)
tstats <- mclapply(gs, function(g) {
  myrows <- which(lapply(gnl,function(x) {
    length(which(x==g))
  } ) > 0 )
  dm[myrows,"t"]
},mc.cores=CORES)
names(tstats) <- gs
tstats <- tstats[order(unlist(lapply(tstats,median)))]
boxplot(tstats,horizontal=TRUE,las=1,
  main="smallest p-val(selfcont)",cex.axis=0.6,
  xlab="t-statistic")
grid()

n=50
# effect size median
sig <- subset(gme_res_df,`fdr(selfcontained)` < 0.05)
gs <- head(rownames(sig[order(-abs(sig$median)),]),n)
tstats <- mclapply(gs, function(g) {
  myrows <- which(lapply(gnl,function(x) {
    length(which(x==g))
  } ) > 0 )
  dm[myrows,"t"]
},mc.cores=CORES)
names(tstats) <- gs
tstats <- tstats[order(unlist(lapply(tstats,median)))]
boxplot(tstats,horizontal=TRUE,las=1,
  main="biggest effect size(median)",cex.axis=0.6,
  xlab="t-statistic")
grid()

```

## Mitch

```{r,dm1_mitch}

dmscore <- data.frame( gme_res_df$median * gme_res_df$sig)

rownames(dmscore) <- rownames(gme_res_df)

colnames(dmscore) <- "metric"

#download.file("https://reactome.org/download/current/ReactomePathways.gmt.zip", destfile="ReactomePathw>
#unzip("ReactomePathways.gmt.zip")
genesets <- gmt_import("ReactomePathways.gmt")

res <- mitch_calc(x=dmscore, genesets=genesets, priority="effect")

head(res$enrichment_result,20) %>%
  kbl(caption = "Top enriched gene sets with GMEA-Mitch") %>%
  kable_paper("hover", full_width = F)

mitch_report(res,outfile="dma1a_mitch.html",overwrite=TRUE)

```

## Promoter analysis only

```{r,promo}

dm <- read.table("dma1a.tsv")
dm <- subset(dm,Regulatory_Feature_Group == "Promoter_Associated")
dm$adj.P.Val <- p.adjust(dm$P.Value)

head(dm,50) %>%
  kbl(caption = "Top significant genes with limma") %>%
  kable_paper("hover", full_width = F)

# histogram of t values
hist(dm$t,breaks=seq(from=-6,to=6,by=1))

# set cores to used for parallel execution
CORES= detectCores()

# make a vector of unique gene names
gn <- unique(unlist(strsplit( dm$UCSC_RefGene_Name ,";")))
gnl <- strsplit( dm$UCSC_RefGene_Name ,";")

# run the test
gme_res <- mclapply( 1:length(gn), function(i) {
  g <- gn[i]
  myrows <- which(lapply(gnl,function(x) {
    length(which(x==g))
  } ) > 0 )
  tstats <- dm[myrows,"t"]
  tstats <- tstats[order(tstats)]
  myn <- length(tstats)
  mymean <- mean(tstats)
  mymedian <- median(tstats)
  wtselfcont <- wilcox.test(tstats)

  res <- c("gene"=g,"nprobes"=myn,"mean"=mymean,"median"=mymedian,
           "p-value(selfcontained)"=wtselfcont$p.value)
} , mc.cores=CORES)

# format the results
gme_res_df <- do.call(rbind, gme_res)
rownames(gme_res_df) <- gme_res_df[,1]
gme_res_df <- gme_res_df[,-1]
tmp <- apply(gme_res_df,2,as.numeric)
rownames(tmp) <- rownames(gme_res_df)
gme_res_df <- as.data.frame(tmp)

# results are sorted by the sum of -log10 of the p-values
gme_res_df$sig <- -log10(gme_res_df[,4])

gme_res_df <- gme_res_df[order(-gme_res_df$sig),]

gme_res_df$`fdr(selfcontained)` <- p.adjust(gme_res_df$`p-value(selfcontained)`)

gme_res_df_promoter <- gme_res_df

write.table(gme_res_df_promoter ,file="gmea_promo.tsv")

```

## Table of top results.

```{r, toptable_promoter}

head(gme_res_df,50) %>%
  kbl(caption = "Top significant genes with GMEA") %>%
  kable_paper("hover", full_width = F)

```

## Volcano plots

```{r,volcano1_promoter}

# volcano selfcont
sig <- subset(gme_res_df,`fdr(selfcontained)` < 0.05)
plot(gme_res_df$median , -log10(gme_res_df$`p-value(selfcontained)`) ,
  xlab="effect size (mean t-stat)", ylab="-log10(p-value)",
  pch=19, cex=0.5, col="gray",main="self contained test")
grid()
points(sig$median , -log10(sig$`p-value(selfcontained)`) ,
  pch=19, cex=0.5, col="red")

```

## Boxplots

Boxplots smallest pvalue.

```{r,box1_promoter}

par(mfrow=c(1,2))
n=50
# self contained
gs <- head(rownames(gme_res_df[order(gme_res_df$`p-value(selfcontained)`),]),n)
tstats <- mclapply(gs, function(g) {
  myrows <- which(lapply(gnl,function(x) {
    length(which(x==g))
  } ) > 0 )
  dm[myrows,"t"]
},mc.cores=CORES)
names(tstats) <- gs
tstats <- tstats[order(unlist(lapply(tstats,median)))]
boxplot(tstats,horizontal=TRUE,las=1,
  main="smallest p-val(selfcont)",cex.axis=0.6,
  xlab="t-statistic")
grid()

n=50
# effect size median
sig <- subset(gme_res_df,`fdr(selfcontained)` < 0.05)
gs <- head(rownames(sig[order(-abs(sig$median)),]),n)
tstats <- mclapply(gs, function(g) {
  myrows <- which(lapply(gnl,function(x) {
    length(which(x==g))
  } ) > 0 )
  dm[myrows,"t"]
},mc.cores=CORES)
names(tstats) <- gs
tstats <- tstats[order(unlist(lapply(tstats,median)))]
boxplot(tstats,horizontal=TRUE,las=1,
  main="biggest effect size(median)",cex.axis=0.6,
  xlab="t-statistic")
grid()

```

## Mitch

```{r,dm1_mitch_promo}

dmscore <- data.frame( gme_res_df$median * gme_res_df$sig)

rownames(dmscore) <- rownames(gme_res_df)

colnames(dmscore) <- "metric"

#download.file("https://reactome.org/download/current/ReactomePathways.gmt.zip", destfile="ReactomePathways.gmt.zip")
#unzip("ReactomePathways.gmt.zip")
genesets <- gmt_import("ReactomePathways.gmt")

res <- mitch_calc(x=dmscore, genesets=genesets,priority="effect")

head(res$enrichment_result,20) %>%
  kbl(caption = "Top enriched gene sets with GMEA-Mitch (promoter only)") %>%
  kable_paper("hover", full_width = F)

mitch_report(res,outfile="dma1a_mitch_promo.html",overwrite=TRUE)

```

## Multi-mitch

```{r,dm1_mitch_promoter}

dmscore_wholegene <- data.frame( gme_res_df_wholegene$median * gme_res_df_wholegene$sig )
rownames(dmscore_wholegene) <- rownames(gme_res_df_wholegene)
colnames(dmscore_wholegene) <- "wholegene"

dmscore_promoter <- data.frame( gme_res_df_promoter$median * gme_res_df_promoter$sig )
rownames(dmscore_promoter) <- rownames(gme_res_df_promoter)
colnames(dmscore_promoter) <- "promoter"

mm <- merge(dmscore_wholegene,dmscore_promoter,by=0)
rownames(mm) <- mm[,1]
mm[,1] = NULL

#download.file("https://reactome.org/download/current/ReactomePathways.gmt.zip", destfile="ReactomePathw>
#unzip("ReactomePathways.gmt.zip")
genesets <- gmt_import("ReactomePathways.gmt")

mmres <- mitch_calc(x=mm, genesets=genesets,priority="effect")

head(mmres$enrichment_result,20) %>%
  kbl(caption = "Top enriched gene sets with GMEA-Mitch (wholegene and promoter)") %>%
  kable_paper("hover", full_width = F)

mitch_report(mmres,outfile="mitch_multi.html",overwrite=TRUE)

```

## Session Information

For reproducibility.

```{r,sessioninfo}

sessionInfo()

```
