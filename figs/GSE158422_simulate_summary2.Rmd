---
title: "Testing gene methylation enrichment analysis approaches using simulated data - summarise data"
author: "The GMEA team"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    fig_width: 7
    fig_height: 7
theme: cosmo
---

## Introduction

Here is an explanation of the different objects:

0. GSA: gres

1. LAT: lacres

2. LTT: lactopres

3. LAW: nlacres

4. LAM: lacmres

5. ALT: alcres

6. ALW: nalcres

7. ALM: almres

```{r,packages}

suppressPackageStartupMessages({
  library("stringi")
  library("psych")
  library("kableExtra")
  library("limma")
  library("missMethyl")
  library("IlluminaHumanMethylation450kmanifest")
  library("IlluminaHumanMethylationEPICanno.ilm10b4.hg19")
  library('org.Hs.eg.db')
  library("mitch")
})

```

## Functions

```{r,functions}

F1 <- function(x,y) {
  ( 2 * x * y ) / ( x + y )
}

summarise <- function(x) {
  PREC <- sum(x[,"TP"]) / ( sum(x[,"TP"]) + sum(x[,"FP"]) )
  REC <- sum(x[,"TP"]) / ( sum(x[,"TP"]) + sum(x[,"FN"]) )
  F <- F1(PREC,REC)
  return(c("PRECISION"=PREC,"RECALL"=REC,"F1"=F))
}

```

## Overall summary

Make a set of three barplots which summarise method performance over the range of group size and
delta values, for gene set sizes of 20, 50 and 200.

```{r,summary,fig.width=5,fig.height=4}

mar = c(5.1, 4.1, 5.1, 2.1)

x <- read.table("GSE158422_simulate_summary2_data.tsv",header=TRUE)
cols <- c("white","gray","black")
NAMES=c("GSA","LAT","LTT","LAW","LAM","ALT","ALW","ALM")

xa <- aggregate(. ~ Method , x , mean)
xao <- t(sapply(NAMES, function(y) { subset(xa,Method==y)}))
xao <- as.matrix(t(xao[,7:9]))
xao <- matrix(unlist(xao),nrow=3)
barplot(xao,beside=TRUE,ylim=c(0,1.2),names.arg=NAMES, ylab="index", col=cols, cex.names=0.7, cex.axis=0.7, main="Overall performance")
abline(h=seq(0,1,0.2),lty=3, lwd=0.9, col="gray")
legend("topleft", inset=.01, c("Precision","Recall","F1"), fill=cols, cex=0.75)

x1 <- subset(x,GPS==20)
x1 %>% kbl(caption="sim 20 res") %>% kable_paper("hover", full_width = F)
x1a <- aggregate(. ~ Method , x1 , mean)
x1ao <- t(sapply(NAMES, function(y) { subset(x1a,Method==y)}))
x1ao <- as.matrix(t(x1ao[,7:9]))
x1ao <- matrix(unlist(x1ao),nrow=3)
barplot(x1ao,beside=TRUE,ylim=c(0,1.2),names.arg=NAMES, ylab="index", col=cols, cex.names=0.7, cex.axis=0.7, main="20 genes per set")
abline(h=seq(0,1,0.2),lty=3, lwd=0.9, col="gray")
legend("topleft", inset=.01, c("Precision","Recall","F1"), fill=cols, cex=0.75)

x2 <- subset(x,GPS==50)
x2 %>% kbl(caption="sim 50 res") %>% kable_paper("hover", full_width = F)
x2a <- aggregate(. ~ Method , x2 , mean)
x2ao <- t(sapply(NAMES, function(y) { subset(x2a,Method==y)}))
x2ao <- as.matrix(t(x2ao[,7:9]))
x2ao <- matrix(unlist(x2ao),nrow=3)
barplot(x2ao,beside=TRUE,ylim=c(0,1.2),names.arg=NAMES, ylab="index", col=cols, cex.names=0.7, cex.axis=0.7, main="50 genes per set")
abline(h=seq(0,1,0.2),lty=3, lwd=0.9, col="gray")

x3 <- subset(x,GPS==100)
x3 %>% kbl(caption="sim 100 res") %>% kable_paper("hover", full_width = F)
x3a <- aggregate(. ~ Method , x3 , mean)
x3ao <- t(sapply(NAMES, function(y) { subset(x3a,Method==y)}))
x3ao <- as.matrix(t(x3ao[,7:9]))
x3ao <- matrix(unlist(x3ao),nrow=3)
barplot(x3ao,beside=TRUE,ylim=c(0,1.1),names.arg=NAMES, ylab="index", col=cols, cex.names=0.7, cex.axis=0.7, main="100 genes per set")
abline(h=seq(0,1,0.2),lty=3, lwd=0.9, col="gray")

y <- data.frame(x1ao[3,],x2ao[3,],x3ao[3,])
colnames(y) <- c("g20","g50","g100")
rownames(y) <- NAMES

cols <- c("white","lightgray","darkgray")
barplot(t(y),beside=TRUE,ylim=c(0,0.8),ylab="F1 index",col=cols,cex.names=0.7, cex.axis=0.7,main="Effect of gene set size")
abline(h=seq(0,1,0.2),lty=3, lwd=0.9, col="gray")
legend("topleft", inset=.01, c("20","50","100"), fill=cols, cex=0.75, title="Genes per set")

```

Make a PNG copy of the figure.

Experimenting with an alternate scheme for figure 1.

```{r,summary_png1}

# ALT FIG1
png(filename="altfig1.png",height=100,width=210,units="mm",res=200)

par(mar = c(2.5, 4.1, 2.1, 0.5))

par(mfrow=c(1,2))

cols <- c("white","gray","black")

barplot(xao,beside=TRUE,ylim=c(0,1),names.arg=NAMES, ylab="index", col=cols, cex.names=0.75, cex.axis=0.75, main="Overall performance")
abline(h=seq(0,1,0.2),lty=3, lwd=0.9, col="gray")
legend("topleft", inset=.01, c("Precision","Recall","F1"), fill=cols, cex=0.75)

cols <- c("white","lightgray","darkgray")
barplot(t(y),beside=TRUE,ylim=c(0,0.65),ylab="F1 index",col=cols,cex.names=0.75, cex.axis=0.75,main="Effect of gene set size")
abline(h=seq(0,1,0.2),lty=3, lwd=0.9, col="gray")
legend("topleft", inset=.01, c("20","50","100"), fill=cols, cex=0.75, title="Genes per set")

dev.off()

```

```{r,summary_png2}


# CANONICAL FIG1
png(filename="fig1.png",height=70,width=210,units="mm",res=200)

par(mar = c(2.5, 4.1, 2.1, 0.5))

par(mfrow=c(1,3))

cols <- c("white","gray","black")

barplot(x1ao,beside=TRUE,ylim=c(0,1),names.arg=NAMES, ylab="index", col=cols, cex.names=0.75, cex.axis=0.75, main="20 genes per set")
abline(h=seq(0,1,0.2),lty=3, lwd=0.9, col="gray")
legend("topleft", inset=.01, c("Precision","Recall","F1"), fill=cols, cex=0.85)

barplot(x2ao,beside=TRUE,ylim=c(0,1),names.arg=NAMES, ylab="index", col=cols, cex.names=0.75, cex.axis=0.75, main="50 genes per set")
abline(h=seq(0,1,0.2),lty=3, lwd=0.9, col="gray")

barplot(x3ao,beside=TRUE,ylim=c(0,1),names.arg=NAMES, ylab="index", col=cols, cex.names=0.75, cex.axis=0.75, main="100 genes per set")
abline(h=seq(0,1,0.2),lty=3, lwd=0.9, col="gray")

dev.off()

par(mfrow=c(1,1))

```

## In depth analysis of GSA vs LAM

Abandoned.


## Session information

```{r,save}

sessionInfo()

```

## Notes

LA

* simla: parametric self-contained

* simlac: parametric competitive

* simnla: nonparametric self-contained

* simnlac: nonparametric competitive

AL

* simal: parametric self-contained

* simalc: parametric competitive

* simnal: nonparametric self-contained

* simnalc: nonparametric competitive
