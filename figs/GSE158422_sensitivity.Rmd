---
title: "GSE158422: DNA methylation in Lung squamous cell carcinoma - gene methylation enrichment analysis - sensitivity analysis"
author: "The GMEA team"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    fig_width: 7
    fig_height: 7
theme: cosmo
---

## Introduction

In the previous analysis, it was shown that the limma-average-mitch (LAM) method
yielded good performance with simulated data.

In this piece of work, we want to ascertain the sensitivity of this approach as compared to
the existing method, GSAmeth.

To achieve this we will analyse with the full 37 patient sample pairs, and repeatedly downsample
the dataset down to n=3 patients.
What we expect is that LAM might have a higher degree of recall as compared to GSAmeth.
We expect LAM will identify gene sets with larger effect sizes (enrichment scores) using
fewer samples.
This means that for a given set of datasets, this approach could yield more findings, or
alternatively if pathway analysis is the primary outcome of a study, it need not be as large, which
can save money and difficulty with establishing large sample collections.

## Requirements

This analysis was run on a 16C/32T computer with 128GB RAM running at 4.2 GHz.
RAM usage can be moderated by reducing the parallel core count.

This analysis was run on an AMD Ryzen Threadripper PRO 5955WX 16-Cores with 3200 MT/s DDR4.

```{r,packages}

suppressPackageStartupMessages({
  library("limma")
  library("eulerr")
  library("IlluminaHumanMethylation450kmanifest")
  library("IlluminaHumanMethylationEPICanno.ilm10b4.hg19")
  library("tictoc")
  library("mitch")
  library("kableExtra")
  library("beeswarm")
  library("missMethyl")
})

CORES=24

TESTING=TRUE

```

## Load data

* annotations

* probe sets

* gene sets

* design matrix

* mval matrix

```{r,annotation}

anno <- getAnnotation(IlluminaHumanMethylationEPICanno.ilm10b4.hg19)
myann <- data.frame(anno[,c("UCSC_RefGene_Name","Regulatory_Feature_Group","Islands_Name","Relation_to_Island")])

gp <- myann[,"UCSC_RefGene_Name",drop=FALSE]
gp2 <- strsplit(gp$UCSC_RefGene_Name,";")
names(gp2) <- rownames(gp)
sets <- split(rep(names(gp2), lengths(gp2)), unlist(gp2))

summary(unlist(lapply(sets,length)))

genesets <- gmt_import("https://ziemann-lab.net/public/gmea_prototype/ReactomePathways.gmt")

if (!file.exists("GSE158422_design.rds")) {
  download.file("https://ziemann-lab.net/public/gmea_prototype/GSE158422_design.rds", "GSE158422_design.rds")
}
design <- readRDS("GSE158422_design.rds")

if (!file.exists("GSE158422_design.rds")) {
 download.file("https://ziemann-lab.net/public/gmea_prototype/GSE158422_mx.rds","GSE158422_mx.rds")
}
mval <- readRDS("GSE158422_mx.rds")

mval_means <- list("tumor"=matrix(colMeans(mval),ncol=2)[,1],"normal"=matrix(colMeans(mval),ncol=2)[,2])
boxplot(mval_means, main="mean probe methylation mval",cex=0,col="white")
beeswarm(mval_means,add=TRUE,pch=1,cex=1.5)
lapply(mval_means,mean)

```

We will assume mean probe methylation is a proxy measure for global methylation.
The boxplot appears to show higher values in tumour samples, based on median and quartiles.
However the mean values are actually lower in tumour samples compared to normal.

Reactome pathways were downloaded on the 14th Sept 2023 from MsigDB.

```{r,gsdl}

gs_entrez <- gmt_import("c2.cp.reactome.v2023.1.Hs.entrez.gmt")

gs_symbols <- gmt_import("c2.cp.reactome.v2023.1.Hs.symbols.gmt")

```

# AL GMEA: all probes

Start with curating the sample info and design matrix.

```{r,samplesheet}

sex <- as.data.frame(design)$sex
tumor <- as.data.frame(design)$tumor
patient <- as.character(unlist(lapply(1:ncol(mval),function(i) {c(i,i)})))
patient <- head(patient,ncol(mval))
design <- model.matrix(~ patient + tumor )

```

## Functions

limma-average-mitch (LAM).

```{r,limmafunc}

# limma
runlimma <- function(mval,design,myann) {
  fit.reduced <- lmFit(mval,design)
  fit.reduced <- eBayes(fit.reduced)
  dm <- topTable(fit.reduced,coef=ncol(design), number = Inf)
  dm <- merge(myann,dm,by=0)
  dm <- dm[order(dm$P.Value),]
  rownames(dm) <- dm$Row.names
  dm$Row.names=NULL
  return(dm)
}

```

The following function is key for the aggregation of probe t-statistic values by gene using the arithmetic mean.
In this step, ~800k probe values are summarised to ~28k genes.

```{r,lamfunction}

# LAM aggregate
agg <- function(dm,cores=1) {
  dm <- dm[which(dm$UCSC_RefGene_Name!=""),]
  gn <- unique(unlist(strsplit( dm$UCSC_RefGene_Name ,";")))
  gnl <- strsplit( dm$UCSC_RefGene_Name ,";")
  gnl <- mclapply(gnl,unique,mc.cores=cores)
  dm$UCSC_RefGene_Name <- gnl
  l <- mclapply(1:nrow(dm), function(i) {
    a <- dm[i,]
    len <- length(a[[1]][[1]])
    tvals <- as.numeric(rep(a["t"],len))
    genes <- a[[1]][[1]]
    data.frame(genes,tvals)
  },mc.cores=cores)
  df <- do.call(rbind,l)
  keep <- names(which(table(df$genes)>1))
  df <- df[df$genes %in% keep,]
  gn <- unique(df$genes)
  gme_res <- lapply( 1:length(gn), function(i) {
    g <- gn[i]
    tstats <- df[which(df$genes==g),"tvals"]
    myn <- length(tstats)
    mymean <- mean(tstats)
    mymedian <- median(tstats)
    top <- tstats[order(-abs(tstats))][1]
    if ( length(tstats) > 2 ) {
      ttest <- t.test(tstats)
      pval <- ttest$p.value
    } else {
      pval = 1
    }
    res <- c("gene"=g,"nprobes"=myn,"mean"=mymean,
      "median"=mymedian, "top"=top, "pval"=pval)
  } )
  gme_res_df <- do.call(rbind, gme_res)
  rownames(gme_res_df) <- gme_res_df[,1]
  gme_res_df <- gme_res_df[,-1]
  tmp <- apply(gme_res_df,2,as.numeric)
  rownames(tmp) <- rownames(gme_res_df)
  gme_res_df <- as.data.frame(tmp)
  gme_res_df$sig <- -log10(gme_res_df[,"pval"])
  gme_res_df <- gme_res_df[order(-gme_res_df$sig),]
  gme_res_df$fdr <- p.adjust(gme_res_df$pval)
  out <- list("df"=df,"gme_res_df"=gme_res_df)
  return(out)
}

```

Function to run mitch analysis.

```{r,mitchfunc}

runmitch <- function(m,genesets,cores=1) {
  suppressMessages({ mres <- mitch_calc(m,genesets,minsetsize=5,cores=cores) })
  mres <- mres$enrichment_result
  rownames(mres) <- mres$set
  mres$set=NULL
  return(mres)
}

```

## Run LAM

Run LAM method on tumour-normal methylation data.
Record timings.

```{r,rungmea}

dim(mval)
dim(design)

tic()
dm <- runlimma(mval=mval,design=design,myann=myann)
toc() ## mean(23.7 26.8 25.4)=23.7
top <- head(dm,20)
top <- top[order(top$logFC),]

tic()
dmagg <- agg(dm,cores=32)
m <- dmagg$gme_res_df[,"mean",drop=FALSE]
lamres <- runmitch(m=m,genesets=gs_symbols,cores=32)
toc()

#tic()
#dmagg <- agg(dm,cores=16)
#m <- dmagg$gme_res_df[,"mean",drop=FALSE]
#lamres <- runmitch(m=m,genesets=gs_symbols,cores=16)
#toc()
#c32<-c()
#c16<-c(123.666,129.619)
#c8<-c()
#c4<-c()
#c2<-c()
#c1<-c()
#duration <- list("c1"=c1, "c2"=c2, "c4"=c4, "c8"=c8, "c16"=c16,"c32"=c32)

top %>%
  kbl(caption="Top significant probes") %>%
  kable_paper("hover", full_width = F)

lamsig <- subset(lamres,p.adjustANOVA<0.05)

top <- head(lamsig,20)
top <- top[order(top$s.dist),]

top %>%
  kbl(caption="Top gene sets (biggest effect size with FDR<0.05)") %>%
  kable_paper("hover", full_width = F)

barnames <- gsub("_"," ",gsub("REACTOME_","",rownames(top)))
cols <- gsub("TRUE","red",gsub("FALSE","blue",as.character(top$s.dist>0)))

par(mar = c(5.1, 29.1, 4.1, 2.1))
barplot(abs(top$s.dist),horiz=TRUE,las=1,names.arg=barnames, cex.names=0.65,
  cex.axis=0.8,col=cols, xlab="Enrichment score",main="Reactomes")
grid()

par( mar = c(5.1, 4.1, 4.1, 2.1) )

lamsig$s.dist

# distinguish up (TRUE) and down (FALSE)
lamsigsets <- paste(rownames(lamsig),as.character(lamsig$s.dist > 0))

```

## Downsample LAM test

This will run the LAM analysis at group sizes of 2, 3, 6, 10, 16, 22 and 30,
50 times each, with pseudorandom seeds from 100 to 5000 jumping up by 100.

```{r,al_down1,fig.height=10}

#testing
SAMPLESIZES=c(22,10,3)
ssres <- lapply(SAMPLESIZES,function(n) {
  SEEDS <- seq(100,300,100)
  dsres <- mclapply(SEEDS, function(SEED) {
    set.seed(SEED)
    mysample <- sample(1:37,n,replace=FALSE)*2
    mysample <- c(mysample,(mysample-1))
    mysample <- mysample[order(mysample)]
    design2 <- design[mysample,]
    design2 <- design2[,colSums(design2)>0]
    mval2 <- mval[,mysample]
    dm2 <- runlimma(mval=mval2,design=design2,myann=myann)
    dmagg2 <- agg(dm2,cores=2)
    m2 <- dmagg2$gme_res_df[,"mean",drop=FALSE]
    lamres2 <- runmitch(m=m2,genesets=gs_symbols,cores=2)
    lamsig2 <- subset(lamres2,p.adjustANOVA<0.05)
    lamsigsets2 <- paste(rownames(lamsig2),as.character(lamsig2$s.dist > 0))
    TOT=length(lamsigsets2)
    TP=length(which(lamsigsets2 %in% lamsigsets))
    FP=length(which(!lamsigsets2 %in% lamsigsets))
    FN=length(which(!lamsigsets %in% lamsigsets2))
    RES=c("TOT"=TOT,"TP"=TP,"FP"=FP,"FN"=FN)
    RES
  },mc.cores=5)
  do.call(rbind,dsres)
})
blah()


# full
if (TESTING == FALSE) {

SAMPLESIZES=c(2,3,6,10,16,22,30)
ssres <- lapply(SAMPLESIZES,function(n) {
  SEEDS <- seq(100,300,100)
  dsres <- mclapply(SEEDS, function(SEED) {
    set.seed(SEED)
    mysample <- sample(1:37,n,replace=FALSE)*2
    mysample <- c(mysample,(mysample-1))
    mysample <- mysample[order(mysample)]
    design2 <- design[mysample,]
    design2 <- design2[,colSums(design2)>0]
    mval2 <- mval[,mysample]
    dm2 <- runlimma(mval=mval2,design=design2,myann=myann)
    dmagg2 <- agg(dm2,cores=2)
    m2 <- dmagg2$gme_res_df[,"mean",drop=FALSE]
    lamres2 <- runmitch(m=m2,genesets=gs_symbols,cores=2)
    lamsig2 <- subset(lamres2,p.adjustANOVA<0.05)
    lamsigsets2 <- paste(rownames(lamsig2),as.character(lamsig2$s.dist > 0))
    TOT=length(lamsigsets2)
    TP=length(which(lamsigsets2 %in% lamsigsets))
    FP=length(which(!lamsigsets2 %in% lamsigsets))
    FN=length(which(!lamsigsets %in% lamsigsets2))
    RES=c("TOT"=TOT,"TP"=TP,"FP"=FP,"FN"=FN)
    RES
  },mc.cores=5)
  do.call(rbind,dsres)
})

}

par(mfrow=c(3,1))

dots <- lapply(ssres,function(x) { x[,"TP"] })
boxplot(dots,names=SAMPLESIZES,col="white",ylab="no. true positives",xlab="sample size",cex=0,main="GMEA") ; grid()
beeswarm(dots,add=TRUE,pch=1,cex=0.6)
abline(h= ssres[[1]][1,1])

dots <- lapply(ssres,function(x) { x[,"FP"] })
boxplot(dots,names=SAMPLESIZES,col="white",ylab="no. false positives",xlab="sample size",cex=0) ; grid()
beeswarm(dots,add=TRUE,pch=1,cex=0.6)

dots <- lapply(ssres,function(x) { x[,"TP"] })
TPdots <- do.call(rbind,dots)
dots <- lapply(ssres,function(x) { x[,"FP"] })
FPdots <- do.call(rbind,dots)
ratio <- t(FPdots / (TPdots + FPdots))
ratio <- lapply(1:ncol(ratio),function(i) {ratio[,i]})
boxplot(ratio,names=SAMPLESIZES,col="white",ylab="proportion FP",xlab="sample size",cex=0) ; grid()
beeswarm(ratio,add=TRUE,pch=1,cex=0.6)

```

# GSAMETH

Run GSA meth on the full dataset.

```{r,rungsameth1}

# limma
runlimma <- function(mval,design,myann) {
  fit.reduced <- lmFit(mval,design)
  fit.reduced <- eBayes(fit.reduced)
  summary(decideTests(fit.reduced))
  dm <- topTable(fit.reduced,coef=4, number = Inf)
  dm <- merge(myann,dm,by=0)
  dm <- dm[order(dm$P.Value),]
  rownames(dm) <- dm$Row.names
  dm$Row.names=NULL
  return(dm)
}

dm <- runlimma(mval,design,myann)

hist(dm$t,breaks=100,xlim=c(-10,10)) ; grid()

head(dm, 10) %>% kbl() %>% kable_paper("hover", full_width = F)

sigup <- rownames(subset(dm,logFC > 0 & adj.P.Val < 0.05))
sigdn <- rownames(subset(dm,logFC < 0 & adj.P.Val < 0.05))

length(sigup)
length(sigdn)

tic()
gsaup <- gsameth(sig.cpg=sigup, all.cpg=rownames(dm), collection=gs_entrez)
gsadn <- gsameth(sig.cpg=sigdn, all.cpg=rownames(dm), collection=gs_entrez)
toc() # 12.9 sec

gsaup <- gsaup[order(gsaup$P.DE),]
gsadn <- gsadn[order(gsadn$P.DE),]

gsig_up <-  subset(gsaup,FDR<0.05)
gsig_up %>% kbl(caption="Hypermethylated pathways") %>% kable_paper("hover", full_width = F)
gsig_dn <-  subset(gsadn,FDR<0.05)
gsig_dn %>% kbl(caption="Hypomethylated pathways") %>% kable_paper("hover", full_width = F)
gsig <- rbind(gsig_up,gsig_dn)

```

Only 4 hyper and 1 hypomethylated gene set were identified.
This is surprising as there were 1299 hypermethylated probes corresponding to 808 genes, and
1016 hypomethylated probes corresponding to 657 genes.

## GSAmeth Downsample

```{r,gsamethdownsample,fig.height=10}

SAMPLESIZES=c(2,3,6,10,16,22,30)

gsres <- lapply(SAMPLESIZES,function(n) {
  SEEDS <- seq(100,5000,100)
  dsres <- mclapply(SEEDS, function(SEED) {
    set.seed(SEED)
    mysample <- sample(1:37,n,replace=FALSE)*2
    mysample <- c(mysample,(mysample-1))
    mysample <- mysample[order(mysample)]
    design2 <- design[mysample,]
    design2 <- design2[,colSums(design2)>0]
    #mval downsample
    mval2 <- mval[,mysample]
    dm2 <- runlimma(mval2,design2,myann)
    sigup2 <- rownames(subset(dm2,adj.P.Val<0.05 & logFC>0))
    sigdn2 <- rownames(subset(dm2,adj.P.Val<0.05 & logFC<0))
    #gsamet
    gsaup2 <- gsameth(sig.cpg=sigup2, all.cpg=rownames(dm2), collection=gs_entrez)
    gsadn2 <- gsameth(sig.cpg=sigdn2, all.cpg=rownames(dm2), collection=gs_entrez)
    gsig_up2 <- subset(gsaup2,FDR<0.05)
    gsig_dn2 <- subset(gsadn2,FDR<0.05)
    gsig2 <- rbind(gsig_up2,gsig_dn2)
    TOT=nrow(gsig2)
    TP=length(which(rownames(gsig2) %in% rownames(gsig)))
    FP=length(which(!rownames(gsig2) %in% rownames(gsig)))
    TPES=0
    RES=c("TOT"=TOT,"TP"=TP,"FP"=FP,"TPES"=TPES)
    RES
  },mc.cores=8)
  do.call(rbind,dsres)
})

mx <- matrix(rep(0,200),ncol=4)
colnames(mx) <- c("TOT","TP","FP","TPES")

# fix empty matrix
gsres <- lapply(gsres,function(x) {
  if ( typeof(x) == "character" ) {
    mx
  } else {
    x
  }
} )

par(mfrow=c(3,1))

dots <- lapply(gsres,function(x) { x[,"TP"] })
boxplot(dots,names=SAMPLESIZES,col="white",ylab="no. true positives",xlab="sample size",cex=0,main="GSAmeth")
beeswarm(dots,add=TRUE,pch=1,cex=0.6)
abline(h=gsres[[1]][1,1])

dots <- lapply(gsres,function(x) { x[,"FP"] })
boxplot(dots,names=SAMPLESIZES,col="white",ylab="no. false positives",xlab="sample size",cex=0)
beeswarm(dots,add=TRUE,pch=1,cex=0.6)

dots <- lapply(gsres,function(x) { x[,"TP"] })
TPdots <- do.call(rbind,dots)
dots <- lapply(gsres,function(x) { x[,"FP"] })
FPdots <- do.call(rbind,dots)
ratio <- t(FPdots / (TPdots + FPdots))
ratio <- lapply(1:ncol(ratio),function(i) {ratio[,i]})
boxplot(ratio,names=SAMPLESIZES,col="white",ylab="proportion FP",xlab="sample size",cex=0) ; grid()
beeswarm(ratio,add=TRUE,pch=1,cex=0.6)

par(mfrow=c(1,1))

```

## Overlap

Use Euler diagrams to find the similarity.
As medians are normally distributed about the zero, one would expect equal numbers of up and down-
methylated gene sets.
Therefore the t-test based approach could be considered better.

```{r,ol1}

alsig_up <- rownames(subset(alsig,t_median>0))
alsig_dn <- rownames(subset(alsig,t_median<0))

msig_up <- subset(mres$enrichment_result,p.adjustANOVA<0.05 & s.dist > 0)$set
msig_dn <- subset(mres$enrichment_result,p.adjustANOVA<0.05 & s.dist < 0)$set

gsig_up <-  rownames(subset(gsaup,FDR<0.05))
gsig_dn <-  rownames(subset(gsadn,FDR<0.05))

v1 <- list("AL up"=alsig_up,"AL dn"=alsig_dn,
  "mitch up"=msig_up,"mitch dn"=msig_dn,
  "GSAmeth up"=gsig_up,"GSAmeth dn"=gsig_dn)

plot(euler(v1),quantities = TRUE)

```

## Session information

```{r,save}

save.image("GSE158422_sensitivity.Rdata")

sessionInfo()

```
