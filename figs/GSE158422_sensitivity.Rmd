---
title: "GSE158422: DNA methylation in Lung squamous cell carcinoma - gene methylation enrichment analysis - sensitivity analysis"
author: "The GMEA team"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    fig_width: 7
    fig_height: 7
theme: cosmo
---

## Introduction

In the previous analysis, it was shown that the limma-average-mitch (LAM) method
yielded good performance with simulated data.

In this piece of work, we want to ascertain the sensitivity of this approach as compared to
the existing method, GSAmeth.

To achieve this we will analyse with the full 37 patient sample pairs, and repeatedly downsample
the dataset down to n=3 patients.
What we expect is that LAM might have a higher degree of recall as compared to GSAmeth.
We expect LAM will identify gene sets with larger effect sizes (enrichment scores) using
fewer samples.
This means that for a given set of datasets, this approach could yield more findings, or
alternatively if pathway analysis is the primary outcome of a study, it need not be as large, which
can save money and difficulty with establishing large sample collections.

## Requirements

This analysis was run on a 16C/32T computer with 128GB RAM running at 4.2 GHz.
RAM usage can be moderated by reducing the parallel core count.

This analysis was run on an AMD Ryzen Threadripper PRO 5955WX 16-Cores with 3200 MT/s DDR4.

```{r,packages}

suppressPackageStartupMessages({
  library("limma")
  library("eulerr")
  library("IlluminaHumanMethylation450kmanifest")
  library("IlluminaHumanMethylationEPICanno.ilm10b4.hg19")
  library("tictoc")
  library("mitch")
  library("kableExtra")
  library("beeswarm")
  library("missMethyl")
  library("gridExtra")
  library("png")
})

CORES=24

```

## Load data

* annotations

* probe sets

* gene sets

* design matrix

* mval matrix

```{r,annotation}

anno <- getAnnotation(IlluminaHumanMethylationEPICanno.ilm10b4.hg19)
myann <- data.frame(anno[,c("UCSC_RefGene_Name","UCSC_RefGene_Group","Islands_Name","Relation_to_Island")])

gp <- myann[,"UCSC_RefGene_Name",drop=FALSE]
gp2 <- strsplit(gp$UCSC_RefGene_Name,";")
names(gp2) <- rownames(gp)
sets <- split(rep(names(gp2), lengths(gp2)), unlist(gp2))

summary(unlist(lapply(sets,length)))

if (!file.exists("GSE158422_design.rds")) {
  download.file("https://ziemann-lab.net/public/gmea_prototype/GSE158422_design.rds", "GSE158422_design.rds")
}
design <- readRDS("GSE158422_design.rds")

if (!file.exists("GSE158422_design.rds")) {
 download.file("https://ziemann-lab.net/public/gmea_prototype/GSE158422_mx.rds","GSE158422_mx.rds")
}
mval <- readRDS("GSE158422_mx.rds")

mval_means <- list("tumor"=matrix(colMeans(mval),ncol=2)[,1],"normal"=matrix(colMeans(mval),ncol=2)[,2])
boxplot(mval_means, main="mean probe methylation mval",cex=0,col="white")
beeswarm(mval_means,add=TRUE,pch=1,cex=1.5)
lapply(mval_means,mean)

```

We will assume mean probe methylation is a proxy measure for global methylation.
The boxplot appears to show higher values in tumour samples, based on median and quartiles.
However the mean values are actually lower in tumour samples compared to normal.

Reactome pathways were downloaded on the 14th Sept 2023 from MsigDB.

```{r,gsdl}

gs_entrez <- gmt_import("c2.cp.reactome.v2023.1.Hs.entrez.gmt")

gs_symbols <- gmt_import("c2.cp.reactome.v2023.1.Hs.symbols.gmt")

```

# AL GMEA: all probes

Start with curating the sample info and design matrix.

```{r,samplesheet}

sex <- as.data.frame(design)$sex
tumor <- as.data.frame(design)$tumor
patient <- as.character(unlist(lapply(1:ncol(mval),function(i) {c(i,i)})))
patient <- head(patient,ncol(mval))
design <- model.matrix(~ patient + tumor )

```

## Functions

limma-average-mitch (LAM).

```{r,limmafunc}

# limma
runlimma <- function(mval,design,myann) {
  fit.reduced <- lmFit(mval,design)
  fit.reduced <- eBayes(fit.reduced)
  dm <- topTable(fit.reduced,coef=ncol(design), number = Inf)
  dm <- merge(myann,dm,by=0)
  dm <- dm[order(dm$P.Value),]
  rownames(dm) <- dm$Row.names
  dm$Row.names=NULL
  return(dm)
}

```

The following function is key for the aggregation of probe t-statistic values by gene using the arithmetic mean.
In this step, ~800k probe values are summarised to ~28k genes.

```{r,lamfunction}

# LAM aggregate
agg <- function(dm,cores=1) {
  dm <- dm[which(dm$UCSC_RefGene_Name!=""),]
  gn <- unique(unlist(strsplit( dm$UCSC_RefGene_Name ,";")))
  gnl <- strsplit( dm$UCSC_RefGene_Name ,";")
  gnl <- mclapply(gnl,unique,mc.cores=cores)
  dm$UCSC_RefGene_Name <- gnl
  l <- mclapply(1:nrow(dm), function(i) {
    a <- dm[i,]
    len <- length(a[[1]][[1]])
    tvals <- as.numeric(rep(a["t"],len))
    genes <- a[[1]][[1]]
    data.frame(genes,tvals)
  },mc.cores=cores)
  df <- do.call(rbind,l)
  keep <- names(which(table(df$genes)>1))
  df <- df[df$genes %in% keep,]
  gn <- unique(df$genes)
  gme_res <- lapply( 1:length(gn), function(i) {
    g <- gn[i]
    tstats <- df[which(df$genes==g),"tvals"]
    myn <- length(tstats)
    mymean <- mean(tstats)
    mymedian <- median(tstats)
    top <- tstats[order(-abs(tstats))][1]
    if ( length(tstats) > 2 ) {
      ttest <- t.test(tstats)
      pval <- ttest$p.value
    } else {
      pval = 1
    }
    res <- c("gene"=g,"nprobes"=myn,"mean"=mymean,
      "median"=mymedian, "top"=top, "pval"=pval)
  } )
  gme_res_df <- do.call(rbind, gme_res)
  rownames(gme_res_df) <- gme_res_df[,1]
  gme_res_df <- gme_res_df[,-1]
  tmp <- apply(gme_res_df,2,as.numeric)
  rownames(tmp) <- rownames(gme_res_df)
  gme_res_df <- as.data.frame(tmp)
  gme_res_df$sig <- -log10(gme_res_df[,"pval"])
  gme_res_df <- gme_res_df[order(-gme_res_df$sig),]
  gme_res_df$fdr <- p.adjust(gme_res_df$pval)
  out <- list("df"=df,"gme_res_df"=gme_res_df)
  return(out)
}

```

Function to run mitch analysis.

```{r,mitchfunc}

runmitch <- function(m,genesets,cores=1) {
  suppressMessages({ mres <- mitch_calc(m,genesets,minsetsize=5,cores=cores, priority="effect") })
  mres <- mres$enrichment_result
  rownames(mres) <- mres$set
  mres$set=NULL
  return(mres)
}

```
## Run limma

Run limma and look at the absolute effect sizes.

```{r,limma1}

dim(mval)
dim(design)

tic()
dm <- runlimma(mval=mval,design=design,myann=myann)
toc() ## mean(23.7 26.8 25.4)=23.7
top <- head(dm,20)
top <- top[order(top$logFC),]

dim(dm)
nrow(subset(dm,adj.P.Val<0.05 & logFC>0))
nrow(subset(dm,adj.P.Val<0.05 & logFC<0))
saveRDS(dm,"GSE158422_dm.rds")

length(unique(unlist(strsplit(subset(dm,adj.P.Val<0.05 & logFC>0)$UCSC_RefGene_Name,";"))))
length(unique(unlist(strsplit(subset(dm,adj.P.Val<0.05 & logFC<0)$UCSC_RefGene_Name,";"))))

length(unique(unlist(strsplit(dm$UCSC_RefGene_Name,";"))))

par(mfrow=c(3,1))

sig <- head(subset(dm,adj.P.Val < 0.05 ),100)
sigmval <- mval[rownames(mval) %in% rownames(sig),]
es <- lapply(1:nrow(sigmval), function(i) {
  x <- sigmval[i,]
  mx <- matrix(x,ncol=2)
  cancer <- median(mx[,1])
  normal <- median(mx[,2])
  abs(cancer-normal)
} )
hist(unlist(es),main="top 100 probes", xlab="probe effect size")
summary(unlist(es))

sig <- head(subset(dm,adj.P.Val < 0.05 ),1000)
sig <- sig[101:1000,]
sigmval <- mval[rownames(mval) %in% rownames(sig),]
es <- lapply(1:nrow(sigmval), function(i) {
  x <- sigmval[i,]
  mx <- matrix(x,ncol=2)
  cancer <- median(mx[,1])
  normal <- median(mx[,2])
  abs(cancer-normal)
} )
hist(unlist(es),main="top 1000 probes ex top 100", xlab="probe effect size")
summary(unlist(es))

sig <- head(subset(dm,adj.P.Val < 0.05 ),10000)
sig <- sig[1001:10000,]
sigmval <- mval[rownames(mval) %in% rownames(sig),]
es <- lapply(1:nrow(sigmval), function(i) {
  x <- sigmval[i,]
  mx <- matrix(x,ncol=2)
  cancer <- median(mx[,1])
  normal <- median(mx[,2])
  abs(cancer-normal)
} )
hist(unlist(es), main="top 10000 probes ex top 1000", xlab="probe effect size")
summary(unlist(es))

par(mfrow=c(1,1))

```

## Run LAM

Run LAM method on tumour-normal methylation data.
Record timings.

```{r,rungmea}

tic()
dmagg <- agg(dm,cores=32)
m <- dmagg$gme_res_df[,"mean",drop=FALSE]
lamres <- runmitch(m=m,genesets=gs_symbols,cores=32)
toc()

#tic()
#dmagg <- agg(dm,cores=16)
#m <- dmagg$gme_res_df[,"mean",drop=FALSE]
#lamres <- runmitch(m=m,genesets=gs_symbols,cores=16)
#toc()
#c32<-c()
#c16<-c(123.666,129.619)
#c8<-c()
#c4<-c()
#c2<-c()
#c1<-c()
#duration <- list("c1"=c1, "c2"=c2, "c4"=c4, "c8"=c8, "c16"=c16,"c32"=c32)

top %>%
  kbl(caption="Top significant probes") %>%
  kable_paper("hover", full_width = F)

lamsig <- subset(lamres,p.adjustANOVA<0.05)

top <- head(lamsig,20)
top <- top[order(top$s.dist),]

top %>%
  kbl(caption="Top gene sets (biggest effect size with FDR<0.05)") %>%
  kable_paper("hover", full_width = F)

barnames <- gsub("_"," ",gsub("REACTOME_","",rownames(top)))
cols <- gsub("TRUE","red",gsub("FALSE","blue",as.character(top$s.dist>0)))

par(mar = c(5.1, 29.1, 4.1, 2.1))
barplot(abs(top$s.dist),horiz=TRUE,las=1,names.arg=barnames, cex.names=0.65,
  cex.axis=0.8,col=cols, xlab="Enrichment score",main="Reactomes")
grid()

par( mar = c(5.1, 4.1, 4.1, 2.1) )

hist(lamsig$s.dist)

# distinguish up (TRUE) and down (FALSE)
lamsigsets <- paste(rownames(lamsig),as.character(lamsig$s.dist > 0))
lamsigsets2 <- gsub(" TRUE"," UP",lamsigsets)
lamsigsets2 <- gsub(" FALSE"," DN",lamsigsets2)

```

## Downsample LAM test

This will run the LAM analysis at group sizes of 2, 3, 6, 10, 16, 22 and 30,
50 times each, with pseudorandom seeds from 100 to 5000 jumping up by 100.

```{r,al_down1,fig.height=10}

SAMPLESIZES=c(2,3,6,10,16,22,30)
ssres <- lapply(SAMPLESIZES,function(n) {
  SEEDS <- seq(100,5000,100)
  dsres <- mclapply(SEEDS, function(SEED) {
    set.seed(SEED)
    mysample <- sample(1:37,n,replace=FALSE)*2
    mysample <- c(mysample,(mysample-1))
    mysample <- mysample[order(mysample)]
    design2 <- design[mysample,]
    design2 <- design2[,colSums(design2)>0]
    mval2 <- mval[,mysample]
    dm2 <- runlimma(mval=mval2,design=design2,myann=myann)
    dmagg2 <- agg(dm2,cores=2)
    m2 <- dmagg2$gme_res_df[,"mean",drop=FALSE]
    lamres2 <- runmitch(m=m2,genesets=gs_symbols,cores=2)
    lamsig2 <- subset(lamres2,p.adjustANOVA<0.05)
    lamsigsets2 <- paste(rownames(lamsig2),as.character(lamsig2$s.dist > 0))
    TOT=length(lamsigsets2)
    TP=length(which(lamsigsets2 %in% lamsigsets))
    FP=length(which(!lamsigsets2 %in% lamsigsets))
    FN=length(which(!lamsigsets %in% lamsigsets2))
    RES=c("TOT"=TOT,"TP"=TP,"FP"=FP,"FN"=FN)
    RES
  },mc.cores=5)
  do.call(rbind,dsres)
})

par(mfrow=c(3,1))

dots <- lapply(ssres,function(x) { x[,"TP"] })
boxplot(dots,names=SAMPLESIZES,col="white",ylab="no. true positives",xlab="sample size",cex=0,main="LAM") ; grid()
beeswarm(dots,add=TRUE,pch=1,cex=0.6)
abline(h=nrow(lamsig))

dots <- lapply(ssres,function(x) { x[,"FP"] })
boxplot(dots,names=SAMPLESIZES,col="white",ylab="no. false positives",xlab="sample size",cex=0) ; grid()
beeswarm(dots,add=TRUE,pch=1,cex=0.6)

dots <- lapply(ssres,function(x) { x[,"TP"] })
TPdots <- do.call(rbind,dots)
dots <- lapply(ssres,function(x) { x[,"FP"] })
FPdots <- do.call(rbind,dots)
ratio <- t(FPdots / (TPdots + FPdots))
ratio <- lapply(1:ncol(ratio),function(i) {ratio[,i]})
boxplot(ratio,names=SAMPLESIZES,col="white",ylab="proportion FP",xlab="sample size",cex=0) ; grid()
beeswarm(ratio,add=TRUE,pch=1,cex=0.6)

par(mfrow=c(1,1))

```

# GSAMETH

Run GSA meth on the full dataset.

```{r,rungsameth1}

dm <- runlimma(mval,design,myann)

hist(dm$t,breaks=100,xlim=c(-10,10)) ; grid()

head(dm, 10) %>% kbl(caption="Top 10 probes by p-value") %>% kable_paper("hover", full_width = F)

sizes=c(1000,5000,10000,20000,50000,100000,200000,300000,350000,400000,450000,500000)
nsigs <- lapply(sizes, function(z) {
  dmsig <- head(dm,z)
  dmsigup <- rownames(subset(dmsig,logFC>0))
  dmsigdn <- rownames(subset(dmsig,logFC<0))
  gsaup <- gsameth(sig.cpg=dmsigup, all.cpg=rownames(dm), collection=gs_entrez, array.type="EPIC")
  rownames(gsaup) <- paste(rownames(gsaup),"UP")
  gsadn <- gsameth(sig.cpg=dmsigdn, all.cpg=rownames(dm), collection=gs_entrez, array.type="EPIC")
  rownames(gsadn) <- paste(rownames(gsadn),"DN")
  nsig <- rownames(subset(rbind(gsaup,gsadn),FDR<0.05))
  return(nsig)
})

names(nsigs) <- sizes
nsigs

par( mar = c(5.1, 6.1, 4.1, 2.1) )
barplot(unlist(lapply(nsigs,length)),horiz=TRUE,las=1,xlab="no. significant sets") ; grid()
mtext("no. probes selected", 2, 4)

#
FCLIM <- c(0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1)
ngsig <- lapply(FCLIM,function(F) {
  sigup <- rownames(subset(dm,logFC > F & adj.P.Val < 0.05))
  sigdn <- rownames(subset(dm,logFC < -F & adj.P.Val < 0.05))
  gsaup <- gsameth(sig.cpg=sigup, all.cpg=rownames(dm), collection=gs_entrez, array.type="EPIC")
  rownames(gsaup) <- paste(rownames(gsaup),"UP")
  gsadn <- gsameth(sig.cpg=sigdn, all.cpg=rownames(dm), collection=gs_entrez, array.type="EPIC")
  rownames(gsadn) <- paste(rownames(gsadn),"DN")
  ngsig <- rownames(subset(rbind(gsaup,gsadn),FDR<0.05))
  return(ngsig)
})

names(ngsig) <- FCLIM
ngsig

par( mar = c(5.1, 6.1, 4.1, 2.1) )
barplot(unlist(lapply(ngsig,length)),horiz=TRUE,las=1,xlab="no. significant sets",xlim=c(0,60)) ; grid()
mtext("fold change threshold", 2, 4)

sigup <- rownames(subset(dm,logFC > 0 & adj.P.Val < 0.05))
sigdn <- rownames(subset(dm,logFC < 0 & adj.P.Val < 0.05))
tic()
gsaup <- gsameth(sig.cpg=sigup, all.cpg=rownames(dm), collection=gs_entrez, array.type="EPIC")
rownames(gsaup) <- paste(rownames(gsaup),"UP")
gsadn <- gsameth(sig.cpg=sigdn, all.cpg=rownames(dm), collection=gs_entrez, array.type="EPIC")
rownames(gsadn) <- paste(rownames(gsadn),"DN")
toc() # 12.9, 12.6, 11.5

gsaup <- gsaup[order(gsaup$P.DE),]
gsadn <- gsadn[order(gsadn$P.DE),]

gsig_up <- subset(gsaup,FDR<0.05)
head(gsig_up,20) %>% kbl(caption="Hypermethylated pathways") %>% kable_paper("hover", full_width = F)

gsig_dn <- subset(gsadn,FDR<0.05)
head(gsig_dn,20) %>% kbl(caption="Hypomethylated pathways") %>% kable_paper("hover", full_width = F)

gsig <- rbind(gsig_up,gsig_dn)
gsigsets <- rownames(gsig)

```

Only 4 hyper and 1 hypomethylated gene set were identified.
This is surprising as there were 1299 hypermethylated probes corresponding to 808 genes, and
1016 hypomethylated probes corresponding to 657 genes.

Calc GSA enrichment scores.
First calculate the background which is the detected genes with annotations.

```{r,GSAes}

detgenes <- unique(unlist(strsplit(dm$UCSC_RefGene_Name,";")))
reactomegenes <- unique(unlist(gs_symbols))
length(reactomegenes)
BG=detgenes[(which(detgenes %in% reactomegenes))]
BGSIZE=length(BG)
FGUP <- unique(unlist(strsplit(subset(dm,logFC > 0 & adj.P.Val < 0.05)$UCSC_RefGene_Name,";")))
FGUP <- FGUP[which(FGUP %in% reactomegenes)]
FGDN <- unique(unlist(strsplit(subset(dm,logFC < 0 & adj.P.Val < 0.05)$UCSC_RefGene_Name,";")))
FGDN <- FGDN[which(FGDN %in% reactomegenes)]

myes <- lapply(1:nrow(gsig), function(i) {
  set=rownames(gsig)[i]
  set1=sapply(strsplit(set," "),"[[",1)
  setg <- gs_symbols[[which(names(gs_symbols)==set1)]]
  setg <- setg[which(setg %in% detgenes)]
  SETSIZE=length(setg)
  NUMUP = (length(intersect(FGUP,setg))/length(FGUP))
  NUMDN = (length(intersect(FGDN,setg))/length(FGDN))
  NUM=max(NUMUP,NUMDN)
  DEN = (SETSIZE/BGSIZE)
  ES=NUM/DEN
  res=c("numerator"=NUM,"denominator"=DEN,"ES"=ES)
  return(res)
})

myes <- data.frame(do.call(rbind,myes))
gsiges <- data.frame(gsig,myes)
gsiges <- head(gsiges[order(-gsiges$ES),],20)
gsiges <- gsiges[order(gsiges$ES),]

barnames <- gsub("_"," ",gsub("REACTOME_","",rownames(gsiges)))
cols <- gsub("FALSE","blue",gsub("TRUE","red",grepl(" UP",barnames)))
barnames <- gsub("DN","",gsub(" UP","",barnames))

par(mar = c(5.1, 27.1, 4.1, 2.1))
barplot(abs(gsiges$ES),horiz=TRUE,las=1,names.arg=barnames, cex.names=0.75,
  cex.axis=0.85, col=cols, xlab="Enrichment score",main="GSA")
grid()

```

## GSAmeth Downsample

```{r,gsamethdownsample,fig.height=10}

SAMPLESIZES=c(2,3,6,10,16,22,30)

gsres <- lapply(SAMPLESIZES,function(n) {
  SEEDS <- seq(100,5000,100)
  dsres <- mclapply(SEEDS, function(SEED) {
    set.seed(SEED)
    mysample <- sample(1:37,n,replace=FALSE)*2
    mysample <- c(mysample,(mysample-1))
    mysample <- mysample[order(mysample)]
    design2 <- design[mysample,]
    design2 <- design2[,colSums(design2)>0]
    #mval downsample
    mval2 <- mval[,mysample]
    dm2 <- runlimma(mval2,design2,myann)
    if ( is.na(dm2$logFC[1]) ) {
      RES=c("TOT"=0,"TP"=0,"FP"=0,"FN"=length(rownames(gsig)) )
    } else {
      sigup2 <- rownames(subset(dm2,adj.P.Val<0.05 & UCSC_RefGene_Name != "" & logFC>0))
      if ( length(sigup2) < 250 ) { sigup2 <- head(rownames(subset(dm2,logFC>0 & UCSC_RefGene_Name != "" )),250) }
      sigdn2 <- rownames(subset(dm2,adj.P.Val<0.05 & UCSC_RefGene_Name != "" & logFC<0))
      if ( length(sigdn2) < 250 ) { sigdn2 <- head(rownames(subset(dm2,logFC<0 & UCSC_RefGene_Name != "" )),250) }
      gsaup2 <- gsameth(sig.cpg=sigup2, all.cpg=rownames(dm2), collection=gs_entrez, array.type="EPIC")
      rownames(gsaup2) <- paste(rownames(gsaup2),"UP")
      gsadn2 <- gsameth(sig.cpg=sigdn2, all.cpg=rownames(dm2), collection=gs_entrez, array.type="EPIC")
      rownames(gsadn2) <- paste(rownames(gsadn2),"DN")
      gsig_up2 <- subset(gsaup2,FDR<0.05)
      gsig_dn2 <- subset(gsadn2,FDR<0.05)
      gsig2 <- rbind(gsig_up2,gsig_dn2)
      TOT=nrow(gsig2)
      TP=length(which(rownames(gsig2) %in% rownames(gsig)))
      FP=length(which(!rownames(gsig2) %in% rownames(gsig)))
      FN=length(which(!rownames(gsig) %in% rownames(gsig2)))
      RES=c("TOT"=TOT,"TP"=TP,"FP"=FP,"FN"=FN)
    }
    RES
  }, mc.cores=5)
  do.call(rbind,dsres)
})

mx <- matrix(rep(0,200),ncol=4)
colnames(mx) <- c("TOT","TP","FP","FN")

# fix empty matrix
gsres <- lapply(gsres,function(x) {
  if ( typeof(x) == "character" ) {
    mx
  } else {
    x
  }
} )

par(mfrow=c(3,1))

dots <- lapply(gsres,function(x) { x[,"TP"] })
boxplot(dots,names=SAMPLESIZES,col="white",ylab="no. true positives",xlab="sample size",cex=0,main="GSAmeth")
beeswarm(dots,add=TRUE,pch=1,cex=0.6)
abline(h=nrow(gsig))

dots <- lapply(gsres,function(x) { x[,"FP"] })
boxplot(dots,names=SAMPLESIZES,col="white",ylab="no. false positives",xlab="sample size",cex=0)
beeswarm(dots,add=TRUE,pch=1,cex=0.6)

dots <- lapply(gsres,function(x) { x[,"TP"] })
TPdots <- do.call(rbind,dots)
dots <- lapply(gsres,function(x) { x[,"FP"] })
FPdots <- do.call(rbind,dots)
ratio <- t(FPdots / (TPdots + FPdots))
ratio <- lapply(1:ncol(ratio),function(i) {ratio[,i]})
boxplot(ratio,names=SAMPLESIZES,col="white",ylab="proportion FP",xlab="sample size",cex=0) ; grid()
beeswarm(ratio,add=TRUE,pch=1,cex=0.6)

par(mfrow=c(1,1))

```

PNG output of boxplots.

```{r,pngboxplot}

png(filename="fig4.png",height=150,width=210,units="mm",res=200)
par(mar = c(4.5, 4.1, 2.1, 0.5))
par(mfrow=c(3,2))

dots <- lapply(ssres,function(x) { x[,"TP"] })
boxplot(dots,names=SAMPLESIZES,col="white",ylab="no. consistent",xlab="sample size",cex=0,main="LAM") ; grid()
beeswarm(dots,add=TRUE,pch=1,cex=0.6)
abline(h=nrow(lamsig))

dots <- lapply(gsres,function(x) { x[,"TP"] })
boxplot(dots,names=SAMPLESIZES,col="white",ylab="no. consistent",xlab="sample size",cex=0,main="GSA") ; grid()
beeswarm(dots,add=TRUE,pch=1,cex=0.6)
abline(h=nrow(gsig))

dots <- lapply(ssres,function(x) { x[,"FP"] })
boxplot(dots,names=SAMPLESIZES,col="white",ylab="no. inconsistent",xlab="sample size",cex=0) ; grid()
beeswarm(dots,add=TRUE,pch=1,cex=0.6)

dots <- lapply(gsres,function(x) { x[,"FP"] })
boxplot(dots,names=SAMPLESIZES,col="white",ylab="no. inconsistent",xlab="sample size",cex=0) ; grid()
beeswarm(dots,add=TRUE,pch=1,cex=0.6)

dots <- lapply(ssres,function(x) { x[,"TP"] })
TPdots <- do.call(rbind,dots)
dots <- lapply(ssres,function(x) { x[,"FP"] })
FPdots <- do.call(rbind,dots)
ratio <- t(FPdots / (TPdots + FPdots))
ratio <- lapply(1:ncol(ratio),function(i) {ratio[,i]})
boxplot(ratio,names=SAMPLESIZES,col="white",ylab="proportion inconsistent",xlab="sample size",cex=0) ; grid()
beeswarm(ratio,add=TRUE,pch=1,cex=0.6)

dots <- lapply(gsres,function(x) { x[,"TP"] })
TPdots <- do.call(rbind,dots)
dots <- lapply(gsres,function(x) { x[,"FP"] })
FPdots <- do.call(rbind,dots)
ratio <- t(FPdots / (TPdots + FPdots))
ratio <- lapply(1:ncol(ratio),function(i) {ratio[,i]})
boxplot(ratio,names=SAMPLESIZES,col="white",ylab="proportion inconsistent",xlab="sample size",cex=0) ; grid()
beeswarm(ratio,add=TRUE,pch=1,cex=0.6)

dev.off()

par(mfrow=c(1,1))

```

## Overlap

Use Euler diagrams to find the similarity.
As medians are normally distributed about the zero, one would expect equal numbers of up and down-
methylated gene sets.
Therefore the t-test based approach could be considered better.

```{r,ol1}

lamsigsets2
gsigsets

v1 <- list("LAM"=lamsigsets2,"GSA"=gsigsets)

plot(euler(v1),quantities = TRUE)

message("common")
intersect(lamsigsets2, gsigsets)

message("specific to LAM")
LAMspec <- setdiff(lamsigsets2, gsigsets)
LAMspec

message("specific to GSA")
GSAspec <- setdiff(gsigsets, lamsigsets2)
GSAspec

message("discordant")
intersect( sapply(strsplit(LAMspec," "),"[[",1) , sapply(strsplit(GSAspec," "),"[[",1) )

```

Now look at the size of these genesets.
Make sure these are ACTUALLY detected.
Make a vector of genes.

```{r,sizes}

detgenes <- unique(unlist(strsplit(dm$UCSC_RefGene_Name,";")))

gsigsets1 <- sapply(strsplit(gsigsets," "),'[[',1)
gsigsets1set <- gs_symbols[names(gs_symbols) %in% gsigsets1]
gsigsets1len <- unlist(lapply(gsigsets1set,function(set) {
  length(set[which(set %in% detgenes)])
}))

lamsigsets1 <- sapply(strsplit(lamsigsets2," "),'[[',1)
lamsigsets1set <- gs_symbols[names(gs_symbols) %in% lamsigsets1]
lamsigsets1len <- unlist(lapply(lamsigsets1set,function(set) {
  length(set[which(set %in% detgenes)])
}))

summary(gsigsets1len)
summary(lamsigsets1len)

GSANAME=paste("GSA (",length(gsigsets1len),")",sep="")
LAMNAME=paste("LAM (",length(lamsigsets1len),")",sep="")
mylist <- list(GSANAME=gsigsets1len,LAMNAME=lamsigsets1len)
boxplot(mylist,cex=0, ylab="gene set size",names=c(GSANAME,LAMNAME))
beeswarm(mylist,pch=19,add=TRUE,cex=0.7)

```

Make Fig3 an euler diagram, boxplot of sizes and barplot of top results.

```{r,eulerbox}


png(filename="euler.png",height=75,width=105,units="mm",res=200)
plot(euler(v1),quantities = TRUE)
dev.off()

pic <- readPNG("euler.png")

png(filename="fig3.png",height=150,width=210,units="mm",res=200)
par(mar = c(4.5, 4.1, 2.1, 0.5))
par(mfrow=c(2,2))

#A overlap of LAM and GSA results
par(mar = c(2,0,2,0))
plot.new()
plot.window(xlim = c(0 , 1), ylim = c( 0, 1))
rasterImage(pic,0,0,1,1)
par(mar = c(4.5, 4.1, 2.1, 0.5))

#B
par(mar = c(4.5, 4.1, 2.1, 0.5))
boxplot(mylist,cex=0, ylab="gene set size",names=c(GSANAME,LAMNAME))
beeswarm(mylist,pch=1,add=TRUE,cex=0.3)

#C
top <- head(lamsig,20)
top <- top[order(top$s.dist),]
barnames <- gsub("_"," ",gsub("REACTOME_","",rownames(top)))
barnames2 <- substring(barnames, 1, 60)
barnames2 <- paste(barnames2,gsub("TRUE","...",gsub("FALSE","",sapply(barnames,nchar)>60)))
cols <- gsub("TRUE","red",gsub("FALSE","blue",as.character(top$s.dist>0)))
par(mar = c(6.1, 20.1, 1.1, 0.5))
barplot(abs(top$s.dist),horiz=TRUE,las=1,names.arg=barnames2, cex.names=0.55,
  cex.axis=0.7,col=cols)
title(main="LAM",cex = 0.8)
title(xlab="S dist",cex=0.6)
grid()

#D
barnames <- gsub("_"," ",gsub("REACTOME_","",rownames(gsiges)))
cols <- gsub("FALSE","blue",gsub("TRUE","red",grepl(" UP",barnames)))
barnames <- gsub("DN","",gsub(" UP","",barnames))
barnames2 <- substring(barnames, 1, 60)
barnames2 <- paste(barnames2,gsub("TRUE","...",gsub("FALSE","",sapply(barnames,nchar)>60)))
par(mar = c(6.1, 20.1, 1.1, 0.5))
barplot(abs(gsiges$ES),horiz=TRUE,las=1,names.arg=barnames2, cex.names=0.55,
  cex.axis=0.7, col=cols, xlab="Enrichment score",main="GSA")
grid()

dev.off()

```

Interesting result that shows that LAM detected gene sets are smaller (59.5) than
GSA sets (205).

This could be due to one of the quirks in some ORA analyses were genes without an
annotation are excluded.

## Session information

```{r,save}

save.image("GSE158422_sensitivity.Rdata")

sessionInfo()

```
