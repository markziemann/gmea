---
title: "Validation of GMEA"
author: "hcy_meth meta-analysis group"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: true
    code_folding: hide
    fig_width: 7
    fig_height: 7
theme: cosmo
---

## Introduction

Previously we demonstrated the ability of GMEA to detect differentially methylated pathways.
There remains a question about how reliable these observations are.
To resolve it, we will use the Hcy dataset which consists of 172 samples.
We will split the data into two groups and analyse these separately.
If the pathway results are similar, then we can be confident about the accuracy.


```{r,libs}

suppressPackageStartupMessages({
  library("missMethyl")
  library("kableExtra")
  library("mitch")
  library("eulerr")
  library("IlluminaHumanMethylation450kmanifest")
  library("IlluminaHumanMethylation450kanno.ilmn12.hg19")
  library("tictoc")
})

```


Load the data.

```{r,load}

design <- readRDS("dm3_design.Rds")
dim(design)

dm <- readRDS("dm3_mx.Rds")
dim(dm)

```

Split the data.


```{r,split1}

g1 <- which(as.data.frame(design)$groups==1)
g2 <- which(as.data.frame(design)$groups==2)
g3 <- which(as.data.frame(design)$groups==3)

seed=100

set.seed(seed); g1s <- sample(g1,floor(length(g1)/2))
g1b <- setdiff(g1,g1s)

set.seed(seed); g2s <- sample(g2,floor(length(g2)/2))
g2b <- setdiff(g2,g2s)

set.seed(seed); g3s <- sample(g3,floor(length(g3)/2))
g3b <- setdiff(g3,g3s)

gxs <- c(g1s,g2s,g3s)
gxs <- gxs[order(gxs)]

gxb <- c(g1b,g2b,g3b)
gxb <- gxb[order(gxb)]

dess <- design[c(gxs),]
dms <- dm[,c(gxs)]

desb <- design[c(gxb),]
dmb <- dm[,c(gxb)]

```

Reactome pathways were downloaded on the 14th Sept 2023 from MsigDB.

```{r,gsdl}

gs_entrez <- gmt_import("c2.cp.reactome.v2023.1.Hs.entrez.gmt")

gs_symbols <- gmt_import("c2.cp.reactome.v2023.1.Hs.symbols.gmt")

```

## GMEA

Now with GMEA.

Start with gathering the annotation set.

```{r,anno}

ann450k <- getAnnotation(IlluminaHumanMethylation450kanno.ilmn12.hg19)
myann <- data.frame(ann450k[,c("UCSC_RefGene_Name","Regulatory_Feature_Group")])
promoters <- grep("Prom",myann$Regulatory_Feature_Group)

```

Histogram of limma t-statistics.

```{r,hist}

dm <- dm[,c("UCSC_RefGene_Name","t")]
hist(dm$t,breaks=seq(from=-6,to=6,by=1)) ; grid()

```

Does 1-sample t-test work better?

```{r,agg_tt}

agg2 <- function(dm) {
  gn <- unique(unlist(strsplit( dm$UCSC_RefGene_Name ,";")))
  gnl <- strsplit( dm$UCSC_RefGene_Name ,";")
  gnl <- mclapply(gnl,unique,mc.cores=CORES)
  dm$UCSC_RefGene_Name <- gnl
  l <- mclapply(1:nrow(dm), function(i) {
    a <- dm[i,]
    len <- length(a[[1]][[1]])
    tvals <- as.numeric(rep(a["t"],len))
    genes <- a[[1]][[1]]
    data.frame(genes,tvals)
  },mc.cores=CORES)
  df <- do.call(rbind,l)
  keep <- names(which(table(df$genes)>1))
  df <- df[df$genes %in% keep,]
  gn <- unique(df$genes)
  gme_res <- lapply( 1:length(gn), function(i) {
    g <- gn[i]
    tstats <- df[which(df$genes==g),"tvals"]
    myn <- length(tstats)
    mymean <- mean(tstats)
    mymedian <- median(tstats)
    tselfcont <- t.test(tstats)
    res <- c("gene"=g,"nprobes"=myn,"mean"=mymean,"median"=mymedian,
      "p-value(sc)"=tselfcont$p.value)
  } )
  gme_res_df <- do.call(rbind, gme_res)
  rownames(gme_res_df) <- gme_res_df[,1]
  gme_res_df <- gme_res_df[,-1]
  tmp <- apply(gme_res_df,2,as.numeric)
  rownames(tmp) <- rownames(gme_res_df)
  gme_res_df <- as.data.frame(tmp)
  gme_res_df$sig <- -log10(gme_res_df[,4])
  gme_res_df <- gme_res_df[order(-gme_res_df$sig),]
  gme_res_df$`fdr(sc)` <- p.adjust(gme_res_df$`p-value(sc)`)
  out <- list("df"=df,"gme_res_df"=gme_res_df)
  return(out)
}

tic()
dmagg2 <- agg2(dm)
toc()
head(dmagg2$gme_res_df) %>% kbl(caption="top gmea genes (t-test)") %>% kable_paper("hover", full_width = F)

hist(dmagg2$gme_res_df$median,breaks=30) ; grid()

```

Conduct a 1-sample t-test.

```{r,t_enrichment_test1}

ttenrich <- function(m,genesets) {
  res <- mclapply( 1:length(genesets), function(i) {
    gs <- genesets[i]
    name <- names(gs)
    n_members <- length(which(rownames(m) %in% gs[[1]]))
    if ( n_members > 4 ) {
      tstats <- m[which(rownames(m) %in% gs[[1]]),]
      myn <- length(tstats)
      mymean <- mean(tstats)
      mymedian <- median(tstats)
      wt <- t.test(tstats)
      res <- c(name,myn,mymean,mymedian,wt$p.value)
    }
  } , mc.cores = CORES/2)
  res_df <- do.call(rbind, res)
  rownames(res_df) <- res_df[,1]
  res_df <- res_df[,-1]
  colnames(res_df) <- c("n_genes","t_mean","t_median","p.value")
  tmp <- apply(res_df,2,as.numeric)
  rownames(tmp) <- rownames(res_df)
  res_df <- tmp
  res_df <- as.data.frame(res_df)
  res_df <- res_df[order(res_df$p.value),]
  res_df$logp <- -log10(res_df$p.value )
  res_df$fdr <- p.adjust(res_df$p.value,method="fdr")
  res_df[order(abs(res_df$p.value)),]
  return(res_df)
}

tic()
tres <- ttenrich(m=m,genesets=gs_symbols)
toc()

head(tres,30) %>%
  kbl(caption = "Top significant genesets") %>%
  kable_paper("hover", full_width = F)

head(tres[order(-abs(tres$t_median)),],30) %>%
  kbl(caption = "Top effect size genesets") %>%
  kable_paper("hover", full_width = F)

sig <- subset(tres,fdr<0.05)
nrow(sig)

head(sig[order(-abs(sig$t_median)),],30) %>%
  kbl(caption = "Top effect size genesets after FDR filtering") %>%
  kable_paper("hover", full_width = F)

plot(tres$t_median,-log10(tres$p.value),pch=19,col="gray")
grid()
points(sig$t_median,-log10(sig$p.value),pch=19,col="red")

tsig <- sig

```

## Overlap

Use Euler diagrams to find the similarity.
As medians are normally distributed about the zero, one would expect equal numbers of up and down-
methylated gene sets.
Therefore the t-test based approach could be considered better.

```{r,ol1}

msig_up <- subset(msig,s.dist>0)$set
msig_dn <- subset(msig,s.dist<0)$set

tsig_up <- rownames(subset(tsig,t_median>0))
tsig_dn <- rownames(subset(tsig,t_median<0))

v1 <- list("mitch up"=msig_up, "mitch dn"=msig_dn,
  "ttest up"=tsig_up,"ttest dn"=tsig_dn)

plot(euler(v1),quantities = TRUE)

```

## TODO

Split data set into 2 halves to show consistency.

## Session information

For reproducibility.

```{r,session}

sessionInfo()

```
