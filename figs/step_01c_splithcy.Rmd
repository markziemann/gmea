---
title: "Validation of GMEA"
author: "hcy_meth meta-analysis group"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: true
    code_folding: hide
    fig_width: 7
    fig_height: 7
theme: cosmo
---

## Introduction

Previously we demonstrated the ability of GMEA to detect differentially methylated pathways.
There remains a question about how reliable these observations are.
To resolve it, we will use the Hcy dataset which consists of 172 samples.
We will split the data into two groups and analyse these separately.
If the pathway results are similar, then we can be confident about the accuracy.


```{r,libs}

suppressPackageStartupMessages({
  library("mitch")
  library("limma")
  library("kableExtra")
  library("eulerr")
  library("IlluminaHumanMethylation450kmanifest")
  library("IlluminaHumanMethylation450kanno.ilmn12.hg19")
  library("tictoc")
})

```

## Load gene sets

Reactome pathways were downloaded on the 14th Sept 2023 from MsigDB.

```{r,gsdl}

gs_entrez <- gmt_import("c2.cp.reactome.v2023.1.Hs.entrez.gmt")

gs_symbols <- gmt_import("c2.cp.reactome.v2023.1.Hs.symbols.gmt")

```

## Load annotation data

```{r,anno}

ann450k <- getAnnotation(IlluminaHumanMethylation450kanno.ilmn12.hg19)
myann <- data.frame(ann450k[,c("UCSC_RefGene_Name","Regulatory_Feature_Group")])
promoters <- grep("Prom",myann$Regulatory_Feature_Group)

```

## Load functions for GMEA

```{r,gmeafunc}

agg <- function(dm,cores=1) {
  gn <- unique(unlist(strsplit( dm$UCSC_RefGene_Name ,";")))
  gnl <- strsplit( dm$UCSC_RefGene_Name ,";")
  gnl <- mclapply(gnl,unique,mc.cores=cores)
  dm$UCSC_RefGene_Name <- gnl
  l <- mclapply(1:nrow(dm), function(i) {
    a <- dm[i,]
    len <- length(a[[1]][[1]])
    tvals <- as.numeric(rep(a["t"],len))
    genes <- a[[1]][[1]]
    data.frame(genes,tvals)
  },mc.cores=cores)
  df <- do.call(rbind,l)
  keep <- names(which(table(df$genes)>1))
  df <- df[df$genes %in% keep,]
  gn <- unique(df$genes)
  gme_res <- lapply( 1:length(gn), function(i) {
    g <- gn[i]
    tstats <- df[which(df$genes==g),"tvals"]
    myn <- length(tstats)
    mymean <- mean(tstats)
    mymedian <- median(tstats)
    tselfcont <- t.test(tstats)
    res <- c("gene"=g,"nprobes"=myn,"mean"=mymean,"median"=mymedian,
      "p-value(sc)"=tselfcont$p.value)
  } )
  gme_res_df <- do.call(rbind, gme_res)
  rownames(gme_res_df) <- gme_res_df[,1]
  gme_res_df <- gme_res_df[,-1]
  tmp <- apply(gme_res_df,2,as.numeric)
  rownames(tmp) <- rownames(gme_res_df)
  gme_res_df <- as.data.frame(tmp)
  gme_res_df$sig <- -log10(gme_res_df[,4])
  gme_res_df <- gme_res_df[order(-gme_res_df$sig),]
  gme_res_df$`fdr(sc)` <- p.adjust(gme_res_df$`p-value(sc)`)
  out <- list("df"=df,"gme_res_df"=gme_res_df)
  return(out)
}

ttenrich <- function(m,genesets,cores=1) {
  res <- mclapply( 1:length(genesets), function(i) {
    gs <- genesets[i]
    name <- names(gs)
    n_members <- length(which(rownames(m) %in% gs[[1]]))
    if ( n_members > 4 ) {
      tstats <- m[which(rownames(m) %in% gs[[1]]),]
      myn <- length(tstats)
      mymean <- mean(tstats)
      mymedian <- median(tstats)
      wt <- t.test(tstats)
      res <- c(name,myn,mymean,mymedian,wt$p.value)
    }
  } , mc.cores = cores)
  res_df <- do.call(rbind, res)
  rownames(res_df) <- res_df[,1]
  res_df <- res_df[,-1]
  colnames(res_df) <- c("n_genes","t_mean","t_median","p.value")
  tmp <- apply(res_df,2,as.numeric)
  rownames(tmp) <- rownames(res_df)
  res_df <- tmp
  res_df <- as.data.frame(res_df)
  res_df <- res_df[order(res_df$p.value),]
  res_df$logp <- -log10(res_df$p.value )
  res_df$fdr <- p.adjust(res_df$p.value,method="fdr")
  res_df[order(abs(res_df$p.value)),]
  return(res_df)
}

```

## Load methylation data

Load the data.

```{r,load}

design <- as.data.frame(readRDS("dm3_design.Rds"))
dim(design)

mx <- readRDS("dm3_mx.Rds")
dim(mx)

```

## Split data

Split the data into two smaller groups (s and b).

```{r,split1}

g1 <- which(as.data.frame(design)$groups==1)
g2 <- which(as.data.frame(design)$groups==2)
g3 <- which(as.data.frame(design)$groups==3)

seed=100

set.seed(seed); g1s <- sample(g1,floor(length(g1)/2))
g1b <- setdiff(g1,g1s)

set.seed(seed); g2s <- sample(g2,floor(length(g2)/2))
g2b <- setdiff(g2,g2s)

set.seed(seed); g3s <- sample(g3,floor(length(g3)/2))
g3b <- setdiff(g3,g3s)

gxs <- c(g1s,g2s,g3s)
gxs <- gxs[order(gxs)]

gxb <- c(g1b,g2b,g3b)
gxb <- gxb[order(gxb)]

dess <- design[c(gxs),]
mxs <- mx[,c(gxs)]

desb <- design[c(gxb),]
mxb <- mx[,c(gxb)]

```

## Limma + GMEA

Using the S dataset, apply limma to conduct differential methylation analysis,
then GMEA.
GMEA has two steps:

1. Aggregate probe t-statistics to genes.

2. Perform enrichment test using 1 sample t-test.

```{r,limmagmea1}

d <- model.matrix(~dess$age+ dess$sex + dess$groups)

fit.reduced <- lmFit(mxs,d)
fit.reduced <- eBayes(fit.reduced)
dm <- topTable(fit.reduced,coef=4, number = Inf)
dma <- merge(myann,dm,by=0)
dma <- dma[order(dma$P.Value),]
dma <- dma[,c("UCSC_RefGene_Name","t")]

dmagg <- agg(dma,cores=8)
m <- dmagg$gme_res_df
m <- m[,"median",drop=FALSE]
tres <- ttenrich(m=m,genesets=gs_symbols,cores=8)
sig <- subset(tres,fdr<0.05)
ssig <- sig

```

Now repeat with the b set.

```{r,limmagmea2}

d <- model.matrix(~desb$age+ desb$sex + desb$groups)

fit.reduced <- lmFit(mxb,d)
fit.reduced <- eBayes(fit.reduced)
dm <- topTable(fit.reduced,coef=4, number = Inf)
dma <- merge(myann,dm,by=0)
dma <- dma[order(dma$P.Value),]
dma <- dma[,c("UCSC_RefGene_Name","t")]

dmagg <- agg(dma,cores=8)
m <- dmagg$gme_res_df
m <- m[,"median",drop=FALSE]
tres <- ttenrich(m=m,genesets=gs_symbols,cores=8)
sig <- subset(tres,fdr<0.05)
bsig <- sig

```

## Overlap

Use Euler diagrams to find the similarity.
As medians are normally distributed about the zero, one would expect equal numbers of up and down-
methylated gene sets.
Therefore the t-test based approach could be considered better.

```{r,ol1}

ssig_up <- rownames(subset(ssig,t_median>0))
ssig_dn <- rownames(subset(ssig,t_median<0))

bsig_up <- rownames(subset(bsig,t_median>0))
bsig_dn <- rownames(subset(bsig,t_median<0))

v1 <- list("s up"=ssig_up, "s dn"=ssig_dn,
  "b up"=bsig_up,"b dn"=bsig_dn)

plot(euler(v1),quantities = TRUE)

```

## TODO

* Make sure it is all working properly.

* Repeat for other seed values and aggregate the results.

## Session information

For reproducibility.

```{r,session}

sessionInfo()

```
