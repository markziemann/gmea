---
title: "Multi-EWAS enrichment example"
author: "The GMEA team"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    fig_width: 7
    fig_height: 7
theme: cosmo
---

Source: https://github.com/markziemann/gmea/

## Introduction

Here we are looking at applying LAM/mitch to a multi-EWAS dataset.

https://pubmed.ncbi.nlm.nih.gov/37410739/

https://zenodo.org/records/8021411

## Requirements

```{r,packages}

suppressPackageStartupMessages({
  library("limma")
  library("eulerr")
  library("IlluminaHumanMethylation450kmanifest")
  library("IlluminaHumanMethylationEPICanno.ilm10b4.hg19")
  library("HGNChelper")
  library("tictoc")
  library("mitch")
  library("gplots")
  library("kableExtra")
  library("beeswarm")
  library("missMethyl")
  library("gridExtra")
  library("png")
})

CORES=8

```

## Load data

Reactome pathways were downloaded on the 14th Sept 2023 from MsigDB.

We'll also score the probes by the signed -log pvalue

```{r,download1}

if(!dir.exists("hillary")){
  dir.create("hillary")
}

if(!file.exists("hillary/compressed-disease-states-ewas.tar.gz")){
  setwd("hillary")
  download.file("https://zenodo.org/records/8021411/files/compressed-disease-states-ewas.tar.gz?download=1",destfile="compressed-disease-states-ewas.tar.gz")
  untar("compressed-disease-states-ewas.tar.gz")
  setwd("..")
}

```

```{r,load}

myfiles1 <- list.files("hillary",pattern="prevalent_full",full.names=TRUE)
l1 <- lapply(myfiles1, read.csv)
l1 <- lapply(l1,function(x) { x[,c("CpG","Beta"),drop=FALSE] } )
names(l1) <- gsub("_gs.csv","",gsub("hillary/prevalent_full_","",myfiles))
str(l1)


myfiles2 <- list.files("hillary",pattern="incident_full",full.names=TRUE)
l2 <- lapply(myfiles2, read.csv)
l2 <- lapply(l2,function(x) { x[,c("CpG","Beta"),drop=FALSE] } )
names(l2) <- gsub("_gs.csv","",gsub("hillary/incident_full_","",myfiles2))
str(l2)

gs_symbols <- gmt_import("c2.cp.reactome.v2023.1.Hs.symbols.gmt")

```

## Curate the annotation

Use all probes on the chip.

Update old gene symbols.

```{r,anno1}

tic()
anno <- getAnnotation(IlluminaHumanMethylationEPICanno.ilm10b4.hg19)
myann <- data.frame(anno[,c("UCSC_RefGene_Name","UCSC_RefGene_Group","Islands_Name","Relation_to_Island")])
gp <- myann[,"UCSC_RefGene_Name",drop=FALSE]
gp2 <- strsplit(gp$UCSC_RefGene_Name,";")
names(gp2) <- rownames(gp)
gp2 <- lapply(gp2,unique)
gt <- stack(gp2)
colnames(gt) <- c("gene","probe")
gt$probe <- as.character(gt$probe)
dim(gt)
str(gt)
toc() #9.0s

tic()
#new.hgnc.table <- getCurrentHumanMap()
new.hgnc.table <- readRDS("new.hgnc.table.rds")
fix <- checkGeneSymbols(gt$gene,map=new.hgnc.table)
fix2 <- fix[which(fix$x != fix$Suggested.Symbol),]
length(unique(fix2$x))
gt$gene <- fix$Suggested.Symbol
toc()

```

## Mitch import

As we don't have the test statistic, we will use the delta beta value,
which according to preliminary investigations works better than the directional
p-value.

l1: prevalent

l2: incident

```{r,mg1}

tic()
m1 <- mitch_import(x=l1,DEtype="prescored",geneTable=gt,geneIDcol="CpG")
toc() #117 sec
head(m1)

tic()
m2 <- mitch_import(x=l2,DEtype="prescored",geneTable=gt,geneIDcol="CpG")
toc() #158 sec
head(m2)

```

## Mitch calc prevalence

Multi-comparison for prevalence.

```{r,mitch1prev}

tic()
mres1 <- mitch_calc(x=m1,genesets=gs_symbols,minsetsize=5,cores=8, priority="effect")
toc() #21.3s

mtable1 <- mres1$enrichment_result
head(mtable1,20)

#numsig manova
nrow(subset(mtable1,p.adjustMANOVA<0.05))
sig <- subset(mtable1,p.adjustMANOVA<0.05)

```

Individual comparisons.

```{r,mitch2prev,fig.height=5,fig.width=5}

r1 <- lapply(1:length(l1),function(i) {
  name=names(l1[i])
  m <- l1[[i]]
  m2 <- mitch_import(x=m,DEtype="prescored",geneTable=gt,geneIDcol="CpG")
  mres <- mitch_calc(x=m2,genesets=gs_symbols,minsetsize=5,cores=2, priority="effect")
  mtable <- mres$enrichment_result
  #mitch_report(res=mres,outfile=paste("mitchreport_prev_",name,".html",sep=""))
})

nup <- lapply(r1,function(r) {
  ups <- subset(r,p.adjustANOVA<0.05 & s.dist>0)$set
  length(ups)
} )

ndn <- lapply(r1,function(r) {
  dns <- subset(r,p.adjustANOVA<0.05 & s.dist<0)$set
  length(dns)
} )

nums <- cbind(unlist(ndn),unlist(nup))
colnames(nums) <- c("dn","up")
nums

rownames(nums) <- gsub("_"," ",rownames(nums))

par(mar = c(5.1, 10.1, 4.1, 2.1))
barplot(t(nums),beside=TRUE,horiz=TRUE,las=1,
  legend.text = c("down","up"),xlab="no. pathways")
abline(v=seq(0,200,50),lty=2,lwd=0.5,col="gray")

pdf("fig8a.pdf",height=6,width=4)
par(mar = c(5.1, 10.1, 4.1, 2.1))
barplot(t(nums),beside=TRUE,horiz=TRUE,las=1,
  legend.text = c("down","up"),xlab="no. pathways")
abline(v=seq(0,200,50),lty=2,lwd=0.5,col="gray")
dev.off()

r2 <- lapply(r1,function(r) {
  ups <- head(subset(r,p.adjustANOVA<0.05 & s.dist > 0.3)$set,5)
  dns <- head(subset(r,p.adjustANOVA<0.05 & s.dist < -0.3)$set,5)
  list("ups"=ups,"dns"=dns)
} )

r2

gsets <- unique(unname(unlist(r2)))
gsets

par(mar = c(5.1, 4.1, 4.1, 2.1))

```

Make a heatmap with these gene sets.

```{r,mitchheatprev,fig.height=9,fig.width=9}

top <- mtable1[which(mtable1$set %in% gsets),]
top <- top[,c(1,4:17)]
rownames(top) <- top$set
top$set=NULL
head(top,2)

rownames(top) <- gsub("REACTOME_","",rownames(top))
rownames(top) <- gsub("_"," ",rownames(top))
colnames(top) <- gsub("^s.","",colnames(top))
colnames(top) <- gsub("_"," ",colnames(top))
colfunc <- colorRampPalette(c("blue", "white", "red"))

heatmap.2(as.matrix(top),scale="none",trace="none",margins=c(6,25),
  col=colfunc(25),cexRow=0.6,cexCol=0.8)

pdf("fig8b.pdf",height=9,width=7)
heatmap.2(as.matrix(top),scale="none",trace="none",margins=c(6,22),
  col=colfunc(25),cexRow=0.5,cexCol=0.8)
dev.off()

```

## Mitch calc incidence

Multi-comparison for incidence.

```{r,mitch1incidence}

tic()
mres2 <- mitch_calc(x=m2,genesets=gs_symbols,minsetsize=5,cores=8, priority="effect")
toc() #29.5s

mtable2 <- mres2$enrichment_result
head(mtable2,20)

#numsig manova
nrow(subset(mtable2,p.adjustMANOVA<0.05))
sig <- subset(mtable2,p.adjustMANOVA<0.05)

```

Individual comparisons.

```{r,mitch2incidence,fig.height=5,fig.width=5}

r1 <- lapply(1:length(l2),function(m) {
  name=names(l2[i])
  m <- l2[[i]]
  m2 <- mitch_import(x=m,DEtype="prescored",geneTable=gt,geneIDcol="CpG")
  mres <- mitch_calc(x=m2,genesets=gs_symbols,minsetsize=5,cores=2, priority="effect")
  mtable <- mres$enrichment_result
  #mitch_report(res=mres,outfile=paste("mitchreport_incid_",name,".html",sep=""))
})

nup <- lapply(r1,function(r) {
  ups <- subset(r,p.adjustANOVA<0.05 & s.dist>0)$set
  length(ups)
} )

ndn <- lapply(r1,function(r) {
  dns <- subset(r,p.adjustANOVA<0.05 & s.dist<0)$set
  length(dns)
} )

nums <- cbind(unlist(ndn),unlist(nup))
colnames(nums) <- c("dn","up")
nums

rownames(nums) <- gsub("ibd","IBD",rownames(nums))
rownames(nums) <- gsub("_"," ",rownames(nums))

par(mar = c(5.1, 10.1, 4.1, 2.1))
barplot(t(nums),beside=TRUE,horiz=TRUE,las=1,
  legend.text = c("down","up"),xlab="no. pathways")
abline(v=seq(0,200,50),lty=2,lwd=0.5,col="gray")

pdf("fig8c.pdf",height=6,width=4)
par(mar = c(5.1, 10.1, 4.1, 2.1))
barplot(t(nums),beside=TRUE,horiz=TRUE,las=1,
  legend.text = c("down","up"),xlab="no. pathways")
abline(v=seq(0,200,50),lty=2,lwd=0.5,col="gray")
dev.off()

r2 <- lapply(r1,function(r) {
  ups <- head(subset(r,p.adjustANOVA<0.05 & s.dist > 0.3)$set,3)
  dns <- head(subset(r,p.adjustANOVA<0.05 & s.dist < -0.3)$set,3)
  list("ups"=ups,"dns"=dns)
} )

r2

gsets <- unique(unname(unlist(r2)))
gsets

par(mar = c(5.1, 4.1, 4.1, 2.1))

```

Make a heatmap with these gene sets.

```{r,mitchheatincidence,fig.height=9,fig.width=9}

top <- mtable2[which(mtable2$set %in% gsets),]
top <- top[,c(1,4:22)]
rownames(top) <- top$set
top$set=NULL
head(top,2)

rownames(top) <- gsub("REACTOME_","",rownames(top))
rownames(top) <- gsub("_"," ",rownames(top))
colnames(top) <- gsub("^s.","",colnames(top))
colnames(top) <- gsub("_"," ",colnames(top))
colnames(top) <- gsub("ibd","IBD",colnames(top))

colfunc <- colorRampPalette(c("blue", "white", "red"))

heatmap.2(as.matrix(top),scale="none",trace="none",margins=c(6,22),
  col=colfunc(25),cexRow=0.6,cexCol=0.7)

pdf("fig8d.pdf",height=9,width=7)
heatmap.2(as.matrix(top),scale="none",trace="none",margins=c(6,20),
  col=colfunc(25),cexRow=0.5,cexCol=0.7)
dev.off()

```

## Randomise data

To demonstrate that mitch is robust to false positives, we can perform
randomisation of the data.

```{r,randomise}

fres <- lapply(1:100,function(i){
  seed=i*1000
  z <- lapply(l2,function(m) {
    m=l2[[1]]
    set.seed=sum(m$Beta)*seed ; m$Beta <- sample(x=m$Beta,replace=FALSE,size=752722)
    m2 <- mitch_import(x=m,DEtype="prescored",geneTable=gt,geneIDcol="CpG")
    mres <- mitch_calc(x=m2,genesets=gs_symbols,minsetsize=5,cores=1, priority="effect")
    mtable <- mres$enrichment_result
    nrow(subset(mtable,p.adjustANOVA<0.05))
  })
  sum(unlist(z))
})

fres <- unlist(fres)
summary(fres)

```

## Session information

```{r,save}

save.image("multi_ewas_example.Rdata")

sessionInfo()

```
